<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
 <head>
  <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="GENERATOR" content="Quadralay WebWorks Publisher Professional Edition 7.0.6.1058" />
  <meta name="TEMPLATEBASE" content="ddxq50_multi" />
  <meta name="LASTUPDATED" content="09/17/09 10:52:10" />
  <title>Restructuring Data: FLWOR Expressions</title>
  <link rel="StyleSheet" href="document.css" type="text/css" />
  <link rel="StyleSheet" href="catalog.css" type="text/css" />
<script type="text/javascript" language="JavaScript1.2" src="wwhdata/common/context.js"></script>
  <script type="text/javascript" language="JavaScript1.2" src="wwhdata/common/towwhdir.js"></script>
  <script type="text/javascript" language="JavaScript1.2" src="wwhdata/common/wwhpagef.js"></script>

  <script type="text/javascript" language="JavaScript1.2">
   <!--
    // Set reference to top level help frame
    //
    var  WWHFrame = WWHGetWWHFrame("");
   // -->
  </script>
 </head>

 <body onLoad="WWHUpdate();">

 <blockquote>
<a name="wp150378"> </a><h2 class="pNewHTMLPageNum">
Restructuring Data: FLWOR Expressions
</h2>
<hr />
<a name="wp150422"> </a><p class="pBody">
The XQuery FLWOR expression is similar to a SQL Select statement that has From and Where clauses. FLWOR is pronounced &quot;flower,&quot; and is an acronym for the keywords used to introduce each clause (for, let, where, order by, and return).
</p>
<a name="wp150427"> </a><p class="pBody">
Here is a FLWOR expression that returns holdings for AMZN:
</p>
<div class="pPreformatted"><pre class="pPreformatted">
for $h in collection(&#39;holdings&#39;)/holdings<a name="wp150429"> </a>
where $h/stockticker = &#39;AMZN&#39;<a name="wp150430"> </a>
order by $h/shares<a name="wp150431"> </a>
return $h<a name="wp150432"> </a>
</pre></div>
<a name="wp150434"> </a><p class="pBody">
In the preceding query, the FLWOR expression performs the following functions:
</p>
<div class="pSmartList1"><ul class="pSmartList1">
<a name="wp150435"> </a><div class="pSmartList1"><li>The for clause binds the variable $h to each holdings element.</li></div><a name="wp150436"> </a><div class="pSmartList1"><li>The where clause filters out bindings of $h for which the stockticker element does not contain the value AMZN. </li></div><a name="wp150437"> </a><div class="pSmartList1"><li>The order by clause determines the order.</li></div><a name="wp150438"> </a><div class="pSmartList1"><li>The return clause produces a result for each binding of $h.</li></div></ul></div>
<a name="wp150440"> </a><p class="pBody">
FLWOR expressions are frequently used to combine related information. The possible combinations are generated by using variables in the for clause and using a where clause to filter out combinations that are not useful. This is known as a &quot;join&quot;. Consider the following expression:
</p>
<div class="pPreformatted"><pre class="pPreformatted">
for $u in collection(&#39;users&#39;)/users,<a name="wp150444"> </a>
    $h in collection(&#39;holdings&#39;)/holdings<a name="wp150445"> </a>
where $u/userid=$h/userid    <a name="wp150446"> </a>
order by $u/lastname, $u/lastname<a name="wp150447"> </a>
return<a name="wp150448"> </a>
  &lt;holding&gt;<a name="wp150449"> </a>
     {<a name="wp150450"> </a>
       $u/firstname,<a name="wp150451"> </a>
       $u/lastname,<a name="wp150452"> </a>
       $h/stockticker,<a name="wp150453"> </a>
       $h/shares<a name="wp150454"> </a>
     }<a name="wp150455"> </a>
  &lt;/holding&gt;<a name="wp150456"> </a>
</pre></div>
<a name="wp150458"> </a><p class="pBody">
This expression finds every pair of users elements and holdings elements whose userid child element has the same value, and then builds a holding element that describes the user and his holdings.
</p>
<a name="wp150461"> </a><p class="pBody">
Now, let&#39;s look at a FLWOR expression that uses a let clause:
</p>
<div class="pPreformatted"><pre class="pPreformatted">
let $h :=  collection(&#39;holdings&#39;)/holdings<a name="wp150463"> </a>
return count($h)<a name="wp150464"> </a>
</pre></div>
<a name="wp150466"> </a><p class="pBody">
A let clause binds a variable to a sequence, which often contains more than one item. In the preceding query, $h is bound to all of the holdings elements in the collection, and the return clause is evaluated. Note the difference between a for clause and a let clause: a for clause always iterates over a sequence, binding a variable to each item; a let clause simply binds a variable to the entire sequence. 
</p>
<a name="wp150622"> </a><p class="pBody">
In the preceding expression, the result is <code class="cCode">8</code>. In contrast, if you use the following for clause:
</p>
<div class="pPreformatted"><pre class="pPreformatted">
for $h in collection(&#39;holdings&#39;)/holdings<a name="wp150468"> </a>
return count($h)<a name="wp150469"> </a>
</pre></div>
<a name="wp150470"> </a><p class="pBody">
The result is a sequence of eight numbers: <code class="cCode">1 1 1 1 1 1 1 1</code>. 
</p>
<a name="wp150472"> </a><p class="pBody">
In some cases, you might find it useful to combine for and let clauses. In the following expression, these two clauses are combined to produce a result that counts the number of stock holdings for each user.
</p>
<div class="pPreformatted"><pre class="pPreformatted">
for $u in collection(&#39;users&#39;)/users<a name="wp150474"> </a>
let $h := collection(&#39;holdings&#39;)/holdings[userid=$u/userid]    <a name="wp150475"> </a>
order by $u/lastname, $u/firstname<a name="wp152323"> </a>
<a name="wp152324"> </a>
return<a name="wp152331"> </a>
    &lt;user nstocks=&quot;{count($h)}&quot;&gt;<a name="wp152325"> </a>
       {<a name="wp151677"> </a>
         $u/firstname,<a name="wp150480"> </a>
         $u/lastname<a name="wp150481"> </a>
       }<a name="wp150482"> </a>
    &lt;/user&gt;<a name="wp150483"> </a>
</pre></div>
<a name="wp150380"> </a><h3 class="pHeading2">
XML Reporting for Relational Sources
</h3>
<a name="wp148702"> </a><p class="pBody">
Many applications need to create rich XML structures from relational sources. For example, Web sites generally create hierarchical displays of the data found in a relational database, and Web messages are often very complex hierarchical structures. For these applications, XQuery can act as an &#8220;XML report writer.&#8221;
</p>
<a name="wp148703"> </a><p class="pBody">
The database tables used in this section are as follows:
</p>
<div class="pSmartList1"><ul class="pSmartList1">
<a name="wp149469"> </a><div class="pSmartList1"><li>users Table</li></div></ul></div>
<div class="pPreformatted"><pre class="pPreformatted">
userid    firstname   lastname   othername  <a name="wp149487"> </a>
<a name="wp152276"> </a>
Minollo   Carlo       Innocenti             <a name="wp151704"> </a>
Jonathan  Jonathan    Robie      William    <a name="wp151705"> </a>
</pre></div>
<div class="pSmartList1"><ul class="pSmartList1">
<a name="wp151706"> </a><div class="pSmartList1"><li>holdings Table</li></div></ul></div>
<div class="pPreformatted"><pre class="pPreformatted">
userid    stockticker   shares             <a name="wp149494"> </a>
<a name="wp152277"> </a>
Jonathan  PRGS          23<a name="wp149495"> </a>
Minollo   PRGS          4000000<a name="wp149496"> </a>
...<a name="wp149516"> </a>
</pre></div>
<div class="pSmartList1"><ul class="pSmartList1">
<a name="wp149492"> </a><div class="pSmartList1"><li>statistical Table</li></div></ul></div>
<div class="pPreformatted"><pre class="pPreformatted">
id companyname            ticker percentagechange annualrevenues location<a name="wp149644"> </a>
<a name="wp152278"> </a>
1  Apple Computer, Inc.   AAPL   -40.80%          5250           Cupertino<a name="wp149645"> </a>
2  Accrue Software, Inc.  ACRU   -57.60%          4.21           Freemont<a name="wp149646"> </a>
...<a name="wp149663"> </a>
</pre></div>
<a name="wp149471"> </a><p class="pBody">
This query creates a portfolio for each user: 
</p>
<div class="pPreformatted"><pre class="pPreformatted">
&lt;portfolios&gt;<a name="wp148729"> </a>
&#160;{
&#160;&#160;&#160;&#160;for $u in collection(&#39;users&#39;)/users
&#160;&#160;&#160;&#160;order by $u/userid
&#160;&#160;&#160;&#160;return
&#160;&#160;&#160;&#160;&#160;&#160;&lt;portfolio id=&quot;{$u/userid}&quot;&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&lt;name&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&lt;first&gt;{data($u/firstname)}&lt;/first&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&lt;last&gt;{data($u/lastname)}&lt;/last&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&lt;/name&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&lt;stocks&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;{
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;for $h in collection(&#39;holdings&#39;)/holdings
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;where $h/userid = $u/userid
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;order by $h/stockticker
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&lt;stock&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&lt;ticker&gt;{data($h/stockticker)}&lt;/ticker&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&lt;shares&gt;{data($h/shares)}&lt;/shares&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&lt;/stock&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;}
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&lt;/stocks&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&lt;/portfolio&gt;
&#160;}
&lt;/portfolios&gt; <a name="wp156310"> </a>
</pre></div>
<a name="wp148730"> </a><p class="pBody">
Here is the result of the preceding query.
</p>
<div class="pPreformatted"><pre class="pPreformatted">
&lt;portfolios&gt;<a name="wp148733"> </a>
  &lt;portfolio id=&quot;Jonathan&quot;&gt;<a name="wp148734"> </a>
    &lt;name&gt;<a name="wp148735"> </a>
      &lt;first&gt;Jonathan&lt;/first&gt;<a name="wp148736"> </a>
      &lt;last&gt;Robie&lt;/last&gt;<a name="wp148737"> </a>
    &lt;/name&gt;<a name="wp148738"> </a>
    &lt;stocks&gt;<a name="wp148739"> </a>
      &lt;stock&gt;<a name="wp148740"> </a>
        &lt;ticker&gt;AMZN&lt;/ticker&gt;<a name="wp148741"> </a>
        &lt;shares&gt;3000&lt;/shares&gt;<a name="wp148742"> </a>
      &lt;/stock&gt;<a name="wp148743"> </a>
      &lt;stock&gt;<a name="wp148744"> </a>
        &lt;ticker&gt;EBAY&lt;/ticker&gt;<a name="wp148745"> </a>
        &lt;shares&gt;4000&lt;/shares&gt;<a name="wp148746"> </a>
      &lt;/stock&gt;<a name="wp148747"> </a>
      &lt;stock&gt;<a name="wp148748"> </a>
        &lt;ticker&gt;IBM&lt;/ticker&gt;<a name="wp148749"> </a>
        &lt;shares&gt;2500&lt;/shares&gt;<a name="wp148750"> </a>
      &lt;/stock&gt;<a name="wp148751"> </a>
      &lt;stock&gt;<a name="wp148752"> </a>
        &lt;ticker&gt;PRGS&lt;/ticker&gt;<a name="wp148753"> </a>
        &lt;shares&gt;23&lt;/shares&gt;<a name="wp148754"> </a>
      &lt;/stock&gt;<a name="wp148755"> </a>
    &lt;/stocks&gt;<a name="wp148756"> </a>
  &lt;/portfolio&gt;<a name="wp148757"> </a>
  &lt;portfolio id=&quot;Minollo&quot;&gt;<a name="wp148758"> </a>
    &lt;name&gt;<a name="wp148759"> </a>
      &lt;first&gt;Carlo&lt;/first&gt;<a name="wp148760"> </a>
      &lt;last&gt;Innocenti&lt;/last&gt;<a name="wp148761"> </a>
    &lt;/name&gt;<a name="wp148762"> </a>
    &lt;stocks&gt;<a name="wp148763"> </a>
      &lt;stock&gt;<a name="wp148764"> </a>
        &lt;ticker&gt;AMZN&lt;/ticker&gt;<a name="wp148765"> </a>
        &lt;shares&gt;3000&lt;/shares&gt;<a name="wp148766"> </a>
    &lt;/stock&gt;<a name="wp148767"> </a>
    &lt;stock&gt;<a name="wp148768"> </a>
      &lt;ticker&gt;EBAY&lt;/ticker&gt;<a name="wp148769"> </a>
      &lt;shares&gt;4000&lt;/shares&gt;<a name="wp148770"> </a>
    &lt;/stock&gt;<a name="wp148771"> </a>
    &lt;stock&gt;<a name="wp148772"> </a>
      &lt;ticker&gt;LU&lt;/ticker&gt;<a name="wp148773"> </a>
      &lt;shares&gt;40000&lt;/shares&gt;<a name="wp148774"> </a>
    &lt;/stock&gt;<a name="wp148775"> </a>
     &lt;stock&gt;<a name="wp148776"> </a>
       &lt;ticker&gt;PRGS&lt;/ticker&gt;<a name="wp148777"> </a>
       &lt;shares&gt;4000000&lt;/shares&gt;<a name="wp148778"> </a>
     &lt;/stock&gt;<a name="wp148779"> </a>
   &lt;/stocks&gt;<a name="wp148780"> </a>
  &lt;/portfolio&gt;<a name="wp148781"> </a>
&lt;/portfolios&gt;<a name="wp148650"> </a>
</pre></div>
<a name="wp156274"> </a><p class="pBody">
NOTE: The query that created this XML result uses the data function, which returns only the value of the stockticker column. Without the data function, the value would be surrounded with an element named stockticker, resulting in, for example:
</p>
<div class="pPreformatted"><pre class="pPreformatted">
&lt;ticker&gt;
&#160;&#160;&lt;stockticker&gt;AMZN&lt;/stockticker&gt;
&lt;/ticker&gt; <a name="wp156277"> </a>
</pre></div>
<a name="wp156278"> </a><h3 class="pHeading2">
Processing XML and Relational Together
</h3>
<a name="wp149080"> </a><p class="pBody">
In some applications, you may need to use XML and relational data together. For example, a configuration file or an incoming Web message might provide information needed to parameterize a query. Suppose you have an XML file that contains a request for a particular kind of report, and your query is to produce that report. For example, the following XML file, request.xml, contains a request to show the performance of Jonathan&#39;s stocks during the period from 2003-01-01 to 2004-06-01.
</p>
<div class="pPreformatted"><pre class="pPreformatted">
&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;request&gt;
&#160;&#160;&lt;performance&gt;
&#160;&#160;&#160;&#160;&lt;UserId&gt;Jonathan&lt;/UserId&gt;
&#160;&#160;&#160;&#160;&lt;start&gt;2003-01-01&lt;/start&gt;
&#160;&#160;&#160;&#160;&lt;end&gt;2004-06-01&lt;/end&gt;
&#160;&#160;&lt;/performance&gt;
&lt;/request&gt; <a name="wp149081"> </a>
</pre></div>
<a name="wp149089"> </a><p class="pBody">
Here is a query that creates a portfolio for the user specified in a request file, during the requested period:
</p>
<div class="pPreformatted"><pre class="pPreformatted">
declare base-uri &quot;file:///c:/programs/examples/JoinXMLToRelational/&quot;;<a name="wp149133"> </a>
declare variable $request := doc(&#39;request.xml&#39;)/request;

for $user in $request/performance/UserId,
&#160;&#160;&#160;&#160;$start in $request/performance/start,
&#160;&#160;&#160;&#160;$end in $request/performance/end
return
&#160;&lt;portfolio UserId=&quot;{$user}&quot;&gt;
&#160;&#160;{ $request }
&#160;&#160;{
&#160;&#160;&#160;&#160;for $st in collection(&#39;holdings&#39;)/holdings,
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;$stats in collection(&#39;statistical&#39;)/statistical
&#160;&#160;&#160;&#160;where $st/userid = $user
&#160;&#160;&#160;&#160;&#160;&#160;and $stats/ticker = $st/stockticker
&#160;&#160;&#160;&#160;return
&#160;&#160;&#160;&#160;&#160;&#160;&lt;stock&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;{ $stats/companyname }
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;{ $st/stockticker }
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;{ $st/shares }
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;{ $stats/annualrevenues }
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;{
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;let $hist := 
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;for $h in collection(&#39;historical&#39;)/historical
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;where $h/ticker = $st/stockticker
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;and xs:date($h/datetraded) gt xs:date($start)
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;and xs:date($h/datetraded) lt xs:date($end)
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return $h
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&lt;performance&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&lt;min&gt;{min($hist/adjustedclose)}&lt;/min&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&lt;max&gt;{max($hist/adjustedclose)}&lt;/max&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&lt;daily&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;{ 
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;for $h in $hist
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return &lt;day&gt;{$h/datetraded, $h/adjustedclose }&lt;/day&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;}
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&lt;/daily&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&lt;/performance&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;}
&#160;&#160;&#160;&#160;&#160;&#160;&lt;/stock&gt; 
&#160;&#160;}
&#160;&lt;/portfolio&gt; <a name="wp156200"> </a>
</pre></div>
 </blockquote>

 <hr />

<script type="text/javascript" language="JavaScript1.2">
   <!--
    document.write(WWHRelatedTopicsDivTag() + WWHPopupDivTag());
   // -->
  </script>

 </body>
</html>
